{% comment %}
  AI Search Booster - Theme Extension
  Injects AI-optimized content for better LLM visibility with comprehensive rollback support
  
  Key Features:
  - Comprehensive JSON-LD structured data for LLM training
  - Non-destructive editing with draft/live content separation
  - One-click rollback capability via metafield toggle
  - Enhanced FAQPage, Product, and BreadcrumbList schemas
  - Organization/Brand graph with Wikidata integration
{% endcomment %}

{% assign namespace = section.settings.custom_namespace | default: 'asb' %}
{% assign enable_structured = section.settings.enable_structured_data | default: true %}
{% assign enable_llm = section.settings.enable_llm_blocks | default: true %}
{% assign show_drafts = section.settings.show_draft_content | default: false %}

{% comment %}
  Main LLM Schema Integration
  This renders the comprehensive schema when enabled
{% endcomment %}
{% if product and enable_structured %}
  {% render 'asb-llm-schema' %}
{% endif %}

{% comment %}
  Visible Content Enhancement
  Shows AI-optimized content when published (not draft)
{% endcomment %}
{% if product %}
  {% comment %}
    Content Selection Logic:
    - If show_drafts is enabled, prefer draft content over live content
    - Otherwise, only show published (live) content
  {% endcomment %}
  {% assign optimized_content = product.metafields[namespace].optimized_content %}
  {% assign optimization_enabled = product.metafields[namespace].enable_schema %}
  {% assign faq_data = product.metafields[namespace].faq_data %}
  
  {% comment %} Draft content variables {% endcomment %}
  {% assign draft_content = product.metafields[namespace].optimized_content_draft %}
  {% assign draft_faq_data = product.metafields[namespace].faq_data_draft %}
  {% assign draft_timestamp = product.metafields[namespace].draft_timestamp %}
  
  {% comment %} Determine which content to show {% endcomment %}
  {% if show_drafts and draft_content %}
    {% assign content_to_show = draft_content %}
    {% assign faq_to_show = draft_faq_data %}
    {% assign is_draft_mode = true %}
  {% else %}
    {% assign content_to_show = optimized_content %}
    {% assign faq_to_show = faq_data %}
    {% assign is_draft_mode = false %}
  {% endif %}
  
  {% comment %} Show content if we have content to display {% endcomment %}
  {% if content_to_show and (optimization_enabled or show_drafts) %}
    <div class="ai-search-booster-content" data-product-id="{{ product.id }}">
      <div class="ai-optimized-content" data-llm="enhanced-content">
        {% if section.settings.show_ai_badge %}
        <div class="ai-badge">
          <span>✨ {% if is_draft_mode %}Draft Preview{% else %}AI-Enhanced Content{% endif %}</span>
          {% if is_draft_mode %}
            <span class="draft-indicator">DRAFT</span>
          {% endif %}
        </div>
        {% endif %}
        
        <div class="optimized-description">
          {{ content_to_show }}
        </div>
        
        {% if faq_to_show %}
          {% assign faq_parsed = faq_to_show | parse_json %}
          {% if faq_parsed.questions.size > 0 %}
          <div class="ai-faq-section">
            <h4>{{ section.settings.faq_heading | default: "Frequently Asked Questions" }}</h4>
            <div class="faq-content">
              {% for faq in faq_parsed.questions %}
              <details class="faq-item">
                <summary>{{ faq.question }}</summary>
                <div class="faq-answer">{{ faq.answer }}</div>
              </details>
              {% endfor %}
            </div>
          </div>
          {% endif %}
        {% endif %}
      </div>
    </div>
  {% endif %}
{% endif %}

{% comment %}
  Blog/Article Content Enhancement
  Similar to product optimization but for blog posts
{% endcomment %}
{% if article %}
  {% assign blog_optimized_content = article.metafields[namespace].optimized_content %}
  {% assign blog_optimization_enabled = article.metafields[namespace].enable_schema %}
  {% assign blog_faq_data = article.metafields[namespace].faq_data %}
  
  {% if blog_optimization_enabled and blog_optimized_content %}
    <div class="ai-search-booster-blog-content" data-article-id="{{ article.id }}">
      <div class="ai-optimized-blog-content" data-llm="enhanced-blog-content">
        {% if section.settings.show_ai_badge %}
        <div class="ai-badge">
          <span>✨ AI-Enhanced Article</span>
        </div>
        {% endif %}
        
        <div class="optimized-blog-description">
          {{ blog_optimized_content }}
        </div>
        
        {% if blog_faq_data %}
          {% assign blog_faq_parsed = blog_faq_data | parse_json %}
          {% if blog_faq_parsed.questions.size > 0 %}
          <div class="ai-blog-faq-section">
            <h4>{{ section.settings.faq_heading | default: "Frequently Asked Questions" }}</h4>
            <div class="faq-content">
              {% for faq in blog_faq_parsed.questions %}
              <details class="faq-item">
                <summary>{{ faq.question }}</summary>
                <div class="faq-answer">{{ faq.answer }}</div>
              </details>
              {% endfor %}
            </div>
          </div>
          {% endif %}
        {% endif %}
      </div>
    </div>
  {% endif %}
  
  {% comment %}
    Blog-specific structured data
    Rendered separately from product schema
  {% endcomment %}
  {% if blog_optimization_enabled and enable_structured %}
    <script type="application/ld+json">
    {
      "@context": "https://schema.org",
      "@type": "BlogPosting",
      "headline": {{ article.title | json }},
      "description": {% if blog_optimized_content %}{{ blog_optimized_content | strip_html | json }}{% else %}{{ article.excerpt | strip_html | json }}{% endif %},
      "author": {
        "@type": "Organization",
        "name": {{ shop.name | json }},
        "url": "{{ shop.url }}"
      },
      "publisher": {
        "@type": "Organization",
        "name": {{ shop.name | json }},
        "url": "{{ shop.url }}"
      },
      "datePublished": "{{ article.created_at | date: '%Y-%m-%d' }}",
      "dateModified": "{{ article.updated_at | date: '%Y-%m-%d' }}",
      "url": "{{ shop.url }}{{ article.url }}",
      "image": {% if article.image %}"{{ article.image | image_url: width: 800 }}"{% else %}"{{ 'logo.png' | asset_url }}"{% endif %}
      {% if blog_faq_data %}
      ,
      "mainEntity": {
        "@type": "FAQPage",
        "mainEntity": [
          {% for faq in blog_faq_parsed.questions %}
          {
            "@type": "Question",
            "name": {{ faq.question | json }},
            "acceptedAnswer": {
              "@type": "Answer", 
              "text": {{ faq.answer | json }}
            }
          }{% unless forloop.last %},{% endunless %}
          {% endfor %}
        ]
      }
      {% endif %}
    }
    </script>
  {% endif %}
{% endif %}

{% schema %}
{
  "name": "AI Search Booster",
  "target": "section",
  "enabled_on": {
    "templates": ["product", "collection", "blog", "article"]
  },
  "settings": [
    {
      "type": "checkbox",
      "id": "enable_structured_data",
      "label": "Enable LLM Structured Data",
      "default": true,
      "info": "Injects comprehensive JSON-LD structured data for LLM training and search engines"
    },
    {
      "type": "checkbox",
      "id": "enable_llm_blocks",
      "label": "Enable Enhanced Content",
      "default": true,
      "info": "Shows AI-optimized content when published"
    },
    {
      "type": "checkbox",
      "id": "show_ai_badge",
      "label": "Show AI-Enhanced Badge",
      "default": true,
      "info": "Displays badge on AI-optimized content"
    },
    {
      "type": "text",
      "id": "faq_heading",
      "label": "FAQ Section Heading",
      "default": "Frequently Asked Questions",
      "info": "Heading for AI-generated FAQ sections"
    },
    {
      "type": "text",
      "id": "custom_namespace",
      "label": "Metafield Namespace",
      "default": "asb",
      "info": "Advanced: Change if using custom metafield namespace"
    },
    {
      "type": "checkbox",
      "id": "show_draft_content",
      "label": "Show Draft Content (Preview Mode)",
      "default": false,
      "info": "Enable to preview draft content before publishing. Only visible to admin users."
    }
  ]
}
{% endschema %}

<style>
  .ai-search-booster-content,
  .ai-search-booster-blog-content {
    margin: 20px 0;
    padding: 20px;
    background-color: #f9f9f9;
    border-radius: 8px;
    border-left: 4px solid #007cba;
  }
  
  .ai-badge {
    display: inline-block;
    background: linear-gradient(135deg, #007cba, #0056b3);
    color: white;
    padding: 4px 12px;
    border-radius: 20px;
    font-size: 0.8em;
    margin-bottom: 15px;
    font-weight: 500;
    position: relative;
  }
  
  .draft-indicator {
    background: #ff6b35;
    color: white;
    padding: 2px 6px;
    border-radius: 12px;
    font-size: 0.7em;
    font-weight: 700;
    margin-left: 8px;
    animation: pulse 2s infinite;
  }
  
  @keyframes pulse {
    0%, 100% { opacity: 1; }
    50% { opacity: 0.7; }
  }
  
  .ai-optimized-content,
  .ai-optimized-blog-content {
    line-height: 1.6;
  }
  
  .optimized-description,
  .optimized-blog-description {
    margin-bottom: 20px;
  }
  
  .ai-faq-section,
  .ai-blog-faq-section {
    margin-top: 25px;
    padding-top: 20px;
    border-top: 1px solid #ddd;
  }
  
  .ai-faq-section h4,
  .ai-blog-faq-section h4 {
    color: #333;
    margin-bottom: 15px;
    font-size: 1.1em;
  }
  
  .faq-content {
    line-height: 1.5;
  }
  
  .faq-item {
    margin-bottom: 12px;
    padding: 15px;
    background: white;
    border-radius: 6px;
    border: 1px solid #e0e0e0;
    transition: box-shadow 0.2s ease;
  }
  
  .faq-item:hover {
    box-shadow: 0 2px 8px rgba(0, 124, 186, 0.1);
  }
  
  .faq-item summary {
    cursor: pointer;
    font-weight: 600;
    color: #007cba;
    list-style: none;
    position: relative;
    padding-right: 25px;
  }
  
  .faq-item summary::-webkit-details-marker {
    display: none;
  }
  
  .faq-item summary::after {
    content: '+';
    position: absolute;
    right: 0;
    top: 0;
    font-size: 1.2em;
    font-weight: bold;
    color: #007cba;
    transition: transform 0.2s ease;
  }
  
  .faq-item[open] summary::after {
    transform: rotate(45deg);
  }
  
  .faq-item[open] summary {
    margin-bottom: 10px;
    padding-bottom: 10px;
    border-bottom: 1px solid #e0e0e0;
  }
  
  .faq-answer {
    color: #555;
    line-height: 1.6;
    margin-top: 10px;
  }
  
  /* Responsive adjustments */
  @media (max-width: 768px) {
    .ai-search-booster-content,
    .ai-search-booster-blog-content {
      margin: 15px 0;
      padding: 15px;
    }
    
    .faq-item {
      padding: 12px;
    }
  }
</style>
